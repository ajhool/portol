var FBVendor=function(){var self=this;this.vsAuth=new VSAuthAdapter("fb",this);this.oAuthToken=null;this.initialize=function(){if(!window.FBPromise.hasReturned){window.FBPromise.callback=function(){self.whoAmI()}}else{self.whoAmI()}window.FBPromise.hasListener=true};var veriStatus={waiting:"WAITING",confirmed:"CONFIRMED",notConnected:"NOT_CONNECTED",denied:"DENIED",vsConfirmed:"VS_CONFIRMED",vsDenied:"VS_DENIED"};this.status=veriStatus.waiting;this.setStatus=function(status){if(status==veriStatus.waiting||status==veriStatus.confirmed||status==veriStatus.denied||status==veriStatus.notConnected||status==veriStatus.vsConfirmed||status==veriStatus.vsDenied){this.status=status}else{console.log("Invalid status")}};this.whoAmI=function(){FB.getLoginStatus(function(response){console.log("Facebook get login status response: ",response);self.updateState(response)})};this.updateState=function(response){if(response.status==="connected"){this.oAuthToken=response.authResponse.accessToken;this.setStatus("CONFIRMED")}else if(response.status==="not_authorized"){this.setStatus("VS_DENIED");console.log("Logged into facebook, but needs to register for my app")}else{this.setStatus("VS_DENIED");console.log("Logged into neither my app nor facebook")}};this.getInfo=function(){FB.api("/me?fields=name,picture,email",function(response){console.log(response)})};this.processStatusUpdate=function(oldVal,newVal){if(newVal===veriStatus.confirmed){console.log("facebook should get from vs");this.getFromVuescape()}else if(newVal===veriStatus.denied){console.log("facebook is not confirmed, dude")}};this.getFromVuescape=function(){if(!this.oAuthToken){return}this.vsAuth.send(this.oAuthToken)};this.logout=function(){FB.logout(function(response){console.log("User is logged out of facebook.")})};return this};var GoogleVendor=function(){var self=this;var veriStatus={waiting:"WAITING",confirmed:"CONFIRMED",notConnected:"NOT_CONNECTED",denied:"DENIED",vsConfirmed:"VS_CONFIRMED",vsDenied:"VS_DENIED"};this.oAuthToken=null;this.vsAuth=new VSAuthAdapter("google",this);this.status=veriStatus.waiting;this.initialize=function(){if(!window.googleUser){window.onGoogleSignIn=function(googleUser){console.log("on google sign in");window.googleUser=googleUser;self.currentUser=googleUser;self.oAuthToken=googleUser.getAuthResponse().id_token;self.setStatus("CONFIRMED")};window.onVSGoogleLoad=function(){self.auth2=gapi.auth2.getAuthInstance();self.auth2.then(function(){self.whoAmI()});console.log("is signed in:",self.auth2.isSignedIn.get())}}else{console.log("Google responded before GoogleVendor code was setup. Should still work.");this.oAuthToken=window.googleUser.getAuthResponse().id_token;this.setStatus("CONFIRMED")}};this.whoAmI=function(){if(this.auth2.isSignedIn.get()){this.currentUser=this.auth2.currentUser.get();this.oAuthToken=this.currentUser.getAuthResponse().id_token;self.setStatus("CONFIRMED")}else{self.setStatus("VS_DENIED")}};this.setStatus=function(status){if(status==veriStatus.waiting||status==veriStatus.confirmed||status==veriStatus.denied||status==veriStatus.notConnected||status==veriStatus.vsConfirmed||status==veriStatus.vsDenied){this.status=status}else{console.log("Invalid status")}};this.processStatusUpdate=function(oldVal,newVal){switch(newVal){case veriStatus.confirmed:this.getFromVuescape();break;case veriStatus.notConnected:break;default:console.log("Unhandled status from google vendor process: "+newVal+".")}};this.getFromVuescape=function(){if(!this.oAuthToken){console.log("Google expected to have an oAuthToken but did not.");return}this.vsAuth.send(this.oAuthToken)};return this};var VS_AuthInterface=function(){var vue=new VueVendor;var fbVendor=new FBVendor;var googleVendor=new GoogleVendor;fbVendor.initialize();googleVendor.initialize();this.start=function(callbacks){whoAmICycle.runCycle(callbacks)};return this};var VSAuthAdapter=function(type,caller){var authTypes={google:"GOOGLE",fb:"FACEBOOK"};if(!authTypes[type]){console.log("ID vendor not supported: "+type+". Available: ",authTypes);return}var mType=authTypes[type];var Message=function(token){this.loggingIn=null;this.loginPlatform=null;this.type=mType;this.oAuthToken=token};this.send=function(token){var self=this;var message=new Message(token);var messageString=JSON.stringify(message);var r=new XMLHttpRequest;var to="https://www.portol.me:5555/api/v0/user/loginorregister";r.open("POST",to,true);r.onreadystatechange=function(){if(r.readyState!=4||r.status!=200){caller.setStatus("VS_DENIED");return}caller.setStatus("VS_CONFIRMED")};r.setRequestHeader("Content-Type","application/json");r.send(messageString);return this};this.reply=function(){}};var VueVendor=function(){var self=this;var veriStatus={waiting:"WAITING",confirmed:"CONFIRMED",notConnected:"NOT_CONNECTED",denied:"DENIED",vsConfirmed:"VS_CONFIRMED",vsDenied:"VS_DENIED"};this.setStatus=function(status){if(status==veriStatus.waiting||status==veriStatus.confirmed||status==veriStatus.denied||status==veriStatus.notConnected||status==veriStatus.vsConfirmed||status==veriStatus.vsDenied){this.status=status}else{console.log("Tried to set unknown status")}};this.status=veriStatus.waiting;this.whoAmI=function(){var r=new XMLHttpRequest;var to="https://www.portol.me:5555/api/v0/user/info/me";r.open("GET",to,true);r.onreadystatechange=function(response){switch(r.status){case 200:self.status=veriStatus.confirmed;break;case 402:self.status=veriStatus.denied;break;default:console.log("Unhandled response type for whoAmI call");break}};r.send()};this.processStatusUpdate=function(oldVal,newVal){if(newVal==veriStatus.confirmed){}}};if(!Object.prototype.watch){Object.defineProperty(Object.prototype,"watch",{enumerable:false,configurable:true,writable:false,value:function(prop,handler){var oldval=this[prop],getter=function(){return oldval},setter=function(newval){if(oldval!==newval){handler.call(this,prop,oldval,newval);oldval=newval}else{return false}};if(delete this[prop]){Object.defineProperty(this,prop,{get:getter,set:setter,enumerable:true,configurable:true})}}})}if(!Object.prototype.unwatch){Object.defineProperty(Object.prototype,"unwatch",{enumerable:false,configurable:true,writable:false,value:function(prop){var val=this[prop];delete this[prop];this[prop]=val}})}var WhoAmICycle=function(vueScape,socialVendors){var self=this;var mIsVSVerified=null;var idVendors=["vuescape","facebook","google"];this.decision="WAITING";this.updateDecision=function(value){if(value==="CONFIRMED"){this.decision="CONFIRMED";this.ondecision(true)}else if(value==="DENIED"){this.decison="DENIED";this.ondecision(false)}};var iAm=null;this.vueScape=vueScape;this.fbVendor=socialVendors.fb;this.googleVendor=socialVendors.google;this.isWaitingOnAnybody=function(newGuy){var isWaiting=true;switch(newGuy){case"fb":isWaiting=!("DENIED"===this.vueScape.status&&"VS_DENIED"===this.googleVendor.status);break;case"vs":isWaiting=!("VS_DENIED"===this.fbVendor.status&&"VS_DENIED"===this.googleVendor.status);break;case"google":isWaiting=!("DENIED"===this.vueScape.status&&"VS_DENIED"===this.fbVendor.status);break;default:isWaiting=!("DENIED"===this.vueScape.status&&"VS_DENIED"===this.fbVendor.status&&"VS_DENIED"===this.googleVendor.status)}if(isWaiting){console.log("Is still waiting on id vendor")}else{console.log("Is not waiting on id vendor.")}return isWaiting};this.vueScape.watch("status",function(field,oldVal,newVal){if("CONFIRMED"==newVal){self.updateDecision("CONFIRMED")}else if("DENIED"===newVal){if(!self.isWaitingOnAnybody("vs")){self.updateDecision("DENIED")}}});this.fbVendor.watch("status",function(field,oldVal,newVal){if(self.decision!=="CONFIRMED"&&self.decision!=="VS_CONFIRMED"){switch(newVal){case"VS_CONFIRMED":self.updateDecision("CONFIRMED");console.log("VS Confirmed with facebook.");break;case"VS_DENIED":if(!self.isWaitingOnAnybody("fb")){self.updateDecision("DENIED")}break;default:this.processStatusUpdate(oldVal,newVal);break}}});this.googleVendor.watch("status",function(field,oldVal,newVal){if(self.decision!=="CONFIRMED"&&self.decision!=="VS_CONFIRMED"){switch(newVal){case"VS_CONFIRMED":self.updateDecision("CONFIRMED");break;case"VS_DENIED":if(!self.isWaitingOnAnybody("google")){self.updateDecision("DENIED")}break;default:this.processStatusUpdate(oldVal,newVal);break}}});this.runCycle=function(callbacks){if(callbacks){this.ondecision=callbacks.ondecision}else{this.ondecision=function(){console.log("Nobody listening to decision.")}}this.vueScape.whoAmI()};return this};